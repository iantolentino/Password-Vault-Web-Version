<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Password Vault (Offline)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  :root{ --bg:#ffffff; --card:#f8f9fa; --text:#111111; --muted:#666666; }
  .dark{ --bg:#0b0b0b; --card:#111111; --text:#efefef; --muted:#9a9a9a; }
  body{ background:var(--bg); color:var(--text); }
  .vault-card{ max-width:520px; margin:6vh auto; border-radius:14px; }
  .btn-rounded{ border-radius:999px; }
  textarea.log-area{ width:100%; height:220px; background:var(--card); color:var(--text); border:1px solid var(--muted); padding:8px; border-radius:8px; }
</style>
</head>
<body>
<div class="container">
  <div class="card shadow-sm vault-card">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">Password Vault</h5>
          <div class="text-muted small">Offline • Encrypted • LocalStorage</div>
        </div>
        <div>
          <button id="toggleTheme" class="btn btn-outline-secondary btn-sm btn-rounded">Toggle Theme</button>
          <button id="btnLogs" class="btn btn-outline-secondary btn-sm btn-rounded">Logs</button>
        </div>
      </div>
      <hr/>
      <div id="messageArea"></div>

      <!-- Setup -->
      <div id="setupBox" style="display:none">
        <h6>Create Master Password</h6>
        <input id="setupMaster" class="form-control mb-2" type="password" placeholder="Master password (6+ chars)">
        <button class="btn btn-dark btn-rounded" id="setupBtn">Create</button>
      </div>

      <!-- Login -->
      <div id="loginBox" style="display:none">
        <h6>Unlock Vault</h6>
        <input id="loginMaster" class="form-control mb-2" type="password" placeholder="Enter master password">
        <button class="btn btn-dark btn-rounded" id="loginBtn">Unlock</button>
      </div>

      <!-- Vault -->
      <div id="vaultBox" style="display:none">
        <div class="d-flex justify-content-between mb-2">
          <strong>Your entries</strong>
          <div>
            <button class="btn btn-dark btn-sm btn-rounded" id="openAddBtn">Add Entry</button>
            <button class="btn btn-outline-secondary btn-sm btn-rounded" id="logoutBtn">Lock</button>
          </div>
        </div>
        <div id="entriesList" style="max-height:360px; overflow:auto;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">Add Entry</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input id="site" class="form-control mb-2" placeholder="Site">
        <input id="username" class="form-control mb-2" placeholder="Username / Email">
        <input id="password" class="form-control mb-2" placeholder="Password">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-rounded" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-dark btn-rounded" id="saveEntryBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h6 class="modal-title">Logs</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <textarea id="logsArea" class="log-area" readonly></textarea>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ------------------------------
// Helpers: crypto + storage
// ------------------------------
async function deriveKey(master) {
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey("raw", enc.encode(master), {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2", salt:new Uint8Array([1,2,3,4]), iterations:100000, hash:"SHA-256"},
    baseKey, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]
  );
}
async function encryptText(text, key){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc);
  return btoa(JSON.stringify({iv:Array.from(iv), data:Array.from(new Uint8Array(buf))}));
}
async function decryptText(payload, key){
  try {
    const obj = JSON.parse(atob(payload));
    const iv = new Uint8Array(obj.iv);
    const data = new Uint8Array(obj.data);
    const buf = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
    return new TextDecoder().decode(buf);
  } catch(e){ return "(decrypt error)"; }
}

// ------------------------------
// Vault logic
// ------------------------------
let unlockedKey = null;
function saveVault(vault){ localStorage.setItem("vault", JSON.stringify(vault)); }
function loadVault(){ return JSON.parse(localStorage.getItem("vault")||"[]"); }
function saveMasterHash(hash){ localStorage.setItem("masterHash", hash); }
function getMasterHash(){ return localStorage.getItem("masterHash"); }
function addLog(msg){ let l=(localStorage.getItem("logs")||""); l+=new Date().toISOString()+" "+msg+"\n"; localStorage.setItem("logs", l); }
function getLogs(){ return localStorage.getItem("logs")||""; }

async function setupMaster(){
  const pw=document.getElementById("setupMaster").value;
  if(pw.length<6) return showMsg("Master must be 6+ chars","danger");
  const hash=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(pw));
  saveMasterHash(Array.from(new Uint8Array(hash)).join(","));
  unlockedKey=await deriveKey(pw);
  addLog("Master created");
  showMsg("Vault created","success");
  checkStatus();
}
async function login(){
  const pw=document.getElementById("loginMaster").value;
  const hash=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(pw));
  const stored=getMasterHash();
  if(stored===Array.from(new Uint8Array(hash)).join(",")){
    unlockedKey=await deriveKey(pw);
    addLog("Login success");
    showMsg("Unlocked","success");
    checkStatus();
  } else { showMsg("Wrong master","danger"); addLog("Login failed"); }
}
function logout(){ unlockedKey=null; showMsg("Locked","info"); checkStatus(); }

async function addEntry(){
  if(!unlockedKey) return;
  const site=document.getElementById("site").value.trim();
  const user=document.getElementById("username").value.trim();
  const pw=document.getElementById("password").value;
  if(!site||!user||!pw) return showMsg("All fields required","danger");
  const vault=loadVault();
  const enc=await encryptText(pw,unlockedKey);
  vault.push({id:Date.now(),site,username:user,password:enc});
  saveVault(vault); addLog("Added entry "+site);
  bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
  loadEntries();
}
async function loadEntries(){
  const list=document.getElementById("entriesList");
  const vault=loadVault();
  list.innerHTML="";
  for(const e of vault){
    const div=document.createElement("div");
    div.className="d-flex justify-content-between align-items-center card p-2 my-2";
    div.innerHTML=`<div><b>${e.site}</b><div class="text-muted small">${e.username}</div></div>
      <div>
        <button class="btn btn-outline-secondary btn-sm btn-rounded" onclick="viewEntry(${e.id})">View</button>
        <button class="btn btn-outline-danger btn-sm btn-rounded" onclick="deleteEntry(${e.id})">Delete</button>
      </div>`;
    list.appendChild(div);
  }
}
async function viewEntry(id){
  const vault=loadVault();
  const found=vault.find(v=>v.id===id);
  if(!found) return;
  const pw=await decryptText(found.password,unlockedKey);
  if(confirm(`Site: ${found.site}\nUser: ${found.username}\nPassword: ${pw}\n\nCopy password?`)){
    navigator.clipboard.writeText(pw); alert("Copied");
  }
}
function deleteEntry(id){
  let vault=loadVault(); vault=vault.filter(v=>v.id!==id);
  saveVault(vault); addLog("Deleted "+id); loadEntries();
}

// ------------------------------
// UI Control
// ------------------------------
function showMsg(t,type="info"){ document.getElementById("messageArea").innerHTML=`<div class="alert alert-${type}">${t}</div>`; setTimeout(()=>{document.getElementById("messageArea").innerHTML=""},3000);}
function checkStatus(){
  if(!getMasterHash()){ document.getElementById("setupBox").style.display="block"; document.getElementById("loginBox").style.display="none"; document.getElementById("vaultBox").style.display="none"; }
  else if(unlockedKey){ document.getElementById("setupBox").style.display="none"; document.getElementById("loginBox").style.display="none"; document.getElementById("vaultBox").style.display="block"; loadEntries(); }
  else { document.getElementById("setupBox").style.display="none"; document.getElementById("loginBox").style.display="block"; document.getElementById("vaultBox").style.display="none"; }
}

// ------------------------------
// Events
// ------------------------------
document.getElementById("setupBtn").onclick=setupMaster;
document.getElementById("loginBtn").onclick=login;
document.getElementById("logoutBtn").onclick=logout;
document.getElementById("openAddBtn").onclick=()=>{document.getElementById("site").value="";document.getElementById("username").value="";document.getElementById("password").value=""; new bootstrap.Modal(document.getElementById("addModal")).show();};
document.getElementById("saveEntryBtn").onclick=addEntry;
document.getElementById("btnLogs").onclick=()=>{document.getElementById("logsArea").value=getLogs(); new bootstrap.Modal(document.getElementById("logsModal")).show();};
document.getElementById("toggleTheme").onclick=()=>{document.body.classList.toggle("dark"); localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");};
if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");

// Start
checkStatus();
</script>
</body>
</html>